

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepNote | Lumina Edition</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22currentColor%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z%22/></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #fafafa; color: #18181b; }
        .serif { font-family: 'Playfair Display', serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f4f4f5; }
        ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 3px; }
        .animate-enter { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(0, 0, 0, 0.05); }
        .glass-panel { background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0, 0, 0, 0.05); }
        input:focus, textarea:focus { outline: none; box-shadow: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- SAFE API KEY LOGIC ---
        // This checks if you have a key saved. If not, it asks for one.
        const getApiKey = () => {
            let key = localStorage.getItem("deepnote_gemini_key");
            if (!key || key.includes("AIzaSy")) { // Basic check for invalid/old hardcoded keys
                key = prompt("Please paste your new Google Gemini API Key:\n(It will be saved on this computer only)");
                if (key) {
                    localStorage.setItem("deepnote_gemini_key", key);
                    window.location.reload(); // Reload to apply
                } else {
                    alert("Without an API Key, the AI 'Synthesize' button will not work.");
                    return null;
                }
            }
            return key;
        };

        const apiKey = localStorage.getItem("deepnote_gemini_key");

        // FIREBASE CONFIG (Kept original)
        const firebaseConfig = {
            apiKey: "AIzaSyCeg_3jVrwafT8SBT63XDXeV0nzfefu1oQ",
            authDomain: "deepnote-22f47.firebaseapp.com",
            projectId: "deepnote-22f47",
            storageBucket: "deepnote-22f47.firebasestorage.app",
            messagingSenderId: "91693051404",
            appId: "1:91693051404:web:d7c363034bd459d6324829",
            measurementId: "G-J414YHQCNB"
        };
        const appId = 'deepnote-lumina';

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- COMPONENTS & LOGIC ---
        const { useState, useEffect, useRef, useMemo } = React;
        
        // Icons
        const IconBase = ({ size = 24, className = "", children, ...p }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...p}>{children}</svg>;
        const Plus = p => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Search = p => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const ArrowRight = p => <IconBase {...p}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const Save = p => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Trash2 = p => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const X = p => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Sparkles = p => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>;
        const Quote = p => <IconBase {...p}><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></IconBase>;
        const Brain = p => <IconBase {...p}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-1.375"/><path d="M17.97 16.625A4 4 0 0 1 18 18"/></IconBase>;
        const Loader2 = p => <IconBase {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const FileText = p => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>;
        const Copy = p => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>;
        const Volume2 = p => <IconBase {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></IconBase>;
        const StopCircle = p => <IconBase {...p}><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></IconBase>;

        const generateAIAnalysis = async (quote, analysis) => {
            const currentKey = getApiKey();
            if (!currentKey) return;

            const prompt = `Context: Dialectical analysis.\nAxiom: "${quote}"\nThesis: "${analysis}"\nTask: Correct grammar, 3 tags, 1 essence word, 1 short phrase, 1 synthesis sentence.\nOutput JSON: { "corrected_text": "str", "tags": ["str"], "one_word": "str", "phrase": "str", "inference": "str" }`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${currentKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (error) {
                alert(`AI Error: ${error.message}\nYour API Key might be invalid or expired.`);
                return null;
            }
        };

        const speakText = async (text) => {
             const currentKey = getApiKey();
             if (!currentKey) return;
             // Basic TTS placeholder logic to avoid complexity errors
             alert("TTS would play here. (Requires advanced setup for local file)");
        };

        // --- UI ---
        const Dashboard = ({ onNewNote, user }) => {
            const [notes, setNotes] = useState([]);
            useEffect(() => {
                if (!user) return;
                db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('notes').orderBy('createdAt', 'desc')
                    .onSnapshot(snap => setNotes(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
            }, [user]);

            return (
                <div className="min-h-screen p-8 max-w-5xl mx-auto animate-enter">
                    <header className="flex justify-between items-center mb-12">
                        <div className="flex items-center gap-4">
                            <div className="w-10 h-10 bg-zinc-900 rounded-xl flex items-center justify-center text-white"><Brain size={20} /></div>
                            <h1 className="text-2xl font-serif font-bold">DeepNote</h1>
                        </div>
                        <button onClick={onNewNote} className="flex gap-2 px-6 py-3 bg-zinc-900 text-white rounded-full hover:bg-zinc-800 transition-all font-medium text-sm">
                            <Plus size={16} /> <span>New Manuscript</span>
                        </button>
                    </header>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {notes.map(note => (
                            <div key={note.id} className="glass-panel p-6 rounded-2xl hover:shadow-lg transition-all">
                                <p className="font-serif italic text-lg mb-4">"{note.quote}"</p>
                                <div className="flex gap-2">{note.points[0]?.tags?.slice(0,2).map((t,i)=><span key={i} className="text-xs font-bold uppercase bg-zinc-100 px-2 py-1 rounded">#{t}</span>)}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const NoteFlow = ({ onComplete, onCancel }) => {
            const [step, setStep] = useState('AXIOM');
            const [quote, setQuote] = useState("");
            const [input, setInput] = useState("");
            const [points, setPoints] = useState([]);
            const [loading, setLoading] = useState(false);

            const handleAnalyze = async () => {
                setLoading(true);
                const res = await generateAIAnalysis(quote, input);
                setLoading(false);
                if (res) {
                    const newPoints = [...points, res];
                    setPoints(newPoints);
                    setInput("");
                    // Simple save for local flow
                    onComplete({ quote, points: newPoints, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                }
            };

            if (step === 'AXIOM') return (
                <div className="min-h-screen flex flex-col justify-center max-w-2xl mx-auto p-8 animate-enter">
                    <h2 className="text-4xl font-serif mb-6">The Axiom</h2>
                    <textarea autoFocus value={quote} onChange={e=>setQuote(e.target.value)} placeholder="Enter quote..." className="w-full text-2xl p-4 border-l-4 border-indigo-500 bg-transparent h-40"/>
                    <button onClick={()=>quote && setStep('DIALECTIC')} className="self-end mt-8 px-8 py-3 bg-zinc-900 text-white rounded-full">Next</button>
                </div>
            );

            return (
                <div className="min-h-screen max-w-4xl mx-auto p-8 animate-enter">
                    <div className="mb-8"><p className="font-serif italic text-xl">"{quote}"</p></div>
                    <textarea autoFocus value={input} onChange={e=>setInput(e.target.value)} placeholder="Your analysis..." className="w-full p-6 rounded-2xl border bg-white h-40 text-lg mb-4"/>
                    <div className="flex justify-end gap-4">
                        <button onClick={onCancel} className="px-6 py-3 text-zinc-500">Cancel</button>
                        <button onClick={handleAnalyze} disabled={loading} className="px-8 py-3 bg-indigo-600 text-white rounded-full flex gap-2 items-center">
                            {loading ? <Loader2 className="animate-spin"/> : <Sparkles size={18}/>} Synthesize
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('DASHBOARD');

            useEffect(() => {
                if(!getApiKey()) return; // Trigger prompt on load
                auth.signInAnonymously().then(u => setUser(u.user)).catch(e => console.error(e));
                auth.onAuthStateChanged(u => u && setUser(u));
            }, []);

            const saveNote = async (data) => {
                if(user) await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('notes').add(data);
                setView('DASHBOARD');
            };

            if (!user) return <div className="h-screen flex items-center justify-center text-zinc-400">Loading / Auth...</div>;
            return view === 'DASHBOARD' ? <Dashboard user={user} onNewNote={()=>setView('EDITOR')}/> : <NoteFlow onComplete={saveNote} onCancel={()=>setView('DASHBOARD')}/>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
