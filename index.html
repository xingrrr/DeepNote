<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepNote | Lumina Edition</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafafa; /* Zinc-50 equivalent */
            color: #18181b; /* Zinc-900 */
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f4f4f5; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d4d4d8; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1aa; 
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-enter {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Glassmorphism - Light Mode Edition */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
        }

        /* Input reset */
        input:focus, textarea:focus {
            outline: none;
            box-shadow: none;
        }
        
        /* Selection Color */
        ::selection {
            background: #e0e7ff; /* Indigo-100 */
            color: #3730a3; /* Indigo-800 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Configuration Section ---
        
        // 1. GEMINI API KEY (REQUIRED)
        // Go to https://aistudio.google.com/app/apikey and create a new key.
        // Paste it inside the quotes below.
        const apiKey = "AIzaSyAhkKOAmrmmMpttuTfvVyy0CbLiql2M7UE"; 

        // 2. FIREBASE CONFIG (ALREADY SET UP)
        // I have preserved your Firebase config here. Do not change this.
        const firebaseConfig = {
            apiKey: "AIzaSyCeg_3jVrwafT8SBT63XDXeV0nzfefu1oQ",
            authDomain: "deepnote-22f47.firebaseapp.com",
            projectId: "deepnote-22f47",
            storageBucket: "deepnote-22f47.firebasestorage.app",
            messagingSenderId: "91693051404",
            appId: "1:91693051404:web:d7c363034bd459d6324829",
            measurementId: "G-J414YHQCNB"
        };

        // CRITICAL: Do not change this appId to ensure data persistence
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'deepnote-lumina';

        // --- Initialization ---
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Firebase Init Error:", e);
                // We won't alert here to avoid spamming the user if configs overlap
            }
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Utilities ---
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const checkApiKey = () => {
            if (!apiKey || apiKey === "" || apiKey.includes("PASTE_YOUR")) {
                alert("MISSING API KEY: Please edit the index.html file and paste your new key from AI Studio into the 'const apiKey' variable at the top of the script.");
                return false;
            }
            return true;
        };

        const getColorForTag = (tag) => {
            const colors = [
                'bg-red-100 text-red-700 border-red-200',
                'bg-orange-100 text-orange-700 border-orange-200',
                'bg-amber-100 text-amber-700 border-amber-200',
                'bg-green-100 text-green-700 border-green-200',
                'bg-emerald-100 text-emerald-700 border-emerald-200',
                'bg-teal-100 text-teal-700 border-teal-200',
                'bg-cyan-100 text-cyan-700 border-cyan-200',
                'bg-blue-100 text-blue-700 border-blue-200',
                'bg-indigo-100 text-indigo-700 border-indigo-200',
                'bg-violet-100 text-violet-700 border-violet-200',
                'bg-purple-100 text-purple-700 border-purple-200',
                'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200',
                'bg-pink-100 text-pink-700 border-pink-200',
                'bg-rose-100 text-rose-700 border-rose-200',
            ];
            let hash = 0;
            for (let i = 0; i < tag.length; i++) {
                hash = tag.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        };

        // --- Audio Context for Playback ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        const playPCM16 = async (base64Data) => {
            try {
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }
                const binaryString = atob(base64Data);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const int16Array = new Int16Array(bytes.buffer);
                const float32Array = new Float32Array(int16Array.length);
                
                for (let i = 0; i < int16Array.length; i++) {
                    float32Array[i] = int16Array[i] / 32768.0;
                }

                // Gemini TTS typically returns 24kHz audio
                const buffer = audioCtx.createBuffer(1, float32Array.length, 24000); 
                buffer.copyToChannel(float32Array, 0);

                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start();
                return source;
            } catch (e) {
                console.error("Audio playback error:", e);
                return null;
            }
        }

        // --- Icons ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const ArrowRight = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>;
        const Quote = (p) => <IconBase {...p}><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></IconBase>;
        const Brain = (p) => <IconBase {...p}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-1.375"/><path d="M17.97 16.625A4 4 0 0 1 18 18"/></IconBase>;
        const Loader2 = (p) => <IconBase {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const FileText = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>;
        const Copy = (p) => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>;
        const Volume2 = (p) => <IconBase {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></IconBase>;
        const StopCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></IconBase>;

        // --- AI Services ---
        const generateAIAnalysis = async (quote, analysis) => {
            if (!checkApiKey()) return {
                corrected_text: analysis,
                tags: ["ConfigError"],
                one_word: "MissingKey",
                phrase: "Setup Required",
                inference: "Please add your Google API Key to the code."
            };

            const prompt = `
            Context: A user is performing a dialectical analysis on a text.
            Axiom (Quote): "${quote}"
            Thesis (User Input): "${analysis}"

            Task:
            1. Correct spelling/grammar of Thesis.
            2. Generate 3-5 academic/topical tags.
            3. Distill into ONE 'Essence' word (noun/adjective).
            4. Create a 'Phrase' summary (2-4 words).
            5. Provide a 'Synthesis' (inference/deeper meaning).

            Output JSON ONLY:
            {
                "corrected_text": "string",
                "tags": ["string", "string"],
                "one_word": "string",
                "phrase": "string",
                "inference": "string"
            }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (error) {
                console.error("AI Error:", error);
                alert(`AI Connection Failed: ${error.message}\n\nPlease check your API Key and Console for details.`);
                return {
                    corrected_text: analysis,
                    tags: ["SystemFailure", "ManualOverride"],
                    one_word: "Error",
                    phrase: "Connection Severed",
                    inference: "The oracle could not be reached. Proceed manually."
                };
            }
        };

        const speakText = async (text, voice = "Kore") => {
            if (!checkApiKey()) return null;
            if (!text) return null;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: {
                                        voiceName: voice
                                    }
                                }
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`TTS API Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                const audioData = data.candidates[0].content.parts[0].inlineData.data;
                return playPCM16(audioData);
            } catch (error) {
                console.error("TTS Error:", error);
                alert(`Speech synthesis unavailable: ${error.message}. Please check your API Key.`);
                return null;
            }
        };

        // --- Components ---

        const CitationOfTheDay = ({ notes, onClick }) => {
            const [isPlaying, setIsPlaying] = useState(false);
            const audioSourceRef = useRef(null);

            const randomNote = useMemo(() => {
                if (!notes.length) return null;
                return notes[Math.floor(Math.random() * notes.length)];
            }, [notes]);

            const handlePlay = async (e) => {
                e.stopPropagation();
                if (isPlaying) {
                    if (audioSourceRef.current) audioSourceRef.current.stop();
                    setIsPlaying(false);
                    return;
                }
                
                setIsPlaying(true);
                const text = `Citation of the day. The Axiom: ${randomNote.quote}. Analysis indicates ${randomNote.points.length} deductions.`;
                audioSourceRef.current = await speakText(text);
                
                if (audioSourceRef.current) {
                    audioSourceRef.current.onended = () => setIsPlaying(false);
                } else {
                    setIsPlaying(false);
                }
            };

            if (!randomNote) return null;

            return (
                <div onClick={() => onClick(randomNote)} className="mb-12 cursor-pointer group">
                    <div className="flex items-center justify-between mb-3">
                        <h3 className="text-xs font-bold text-indigo-600 uppercase tracking-widest flex items-center gap-2">
                            <Sparkles size={14} /> Citation of the Day
                        </h3>
                        <button 
                            onClick={handlePlay}
                            className="p-1.5 rounded-full hover:bg-indigo-100 text-indigo-600 transition-colors z-20"
                        >
                            {isPlaying ? <StopCircle size={16} /> : <Volume2 size={16} />}
                        </button>
                    </div>
                    <div className="glass p-8 rounded-2xl border-l-4 border-indigo-500 relative overflow-hidden transition-all duration-300 group-hover:shadow-lg group-hover:bg-white/80">
                         <div className="absolute top-0 right-0 p-32 bg-indigo-100 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none opacity-50"></div>
                        <p className="text-2xl md:text-3xl font-serif text-zinc-800 italic leading-relaxed mb-4 relative z-10">
                            "{randomNote.quote}"
                        </p>
                        <div className="flex items-center gap-3 text-sm text-zinc-500 font-mono">
                            <span>— Analyzed on {new Date(randomNote.createdAt?.toDate()).toLocaleDateString()}</span>
                            <span className="w-1 h-1 bg-zinc-400 rounded-full"></span>
                            <span>{randomNote.points?.length} Deductions</span>
                        </div>
                    </div>
                </div>
            );
        };

        const ReaderModal = ({ note, onClose }) => {
            const [isReading, setIsReading] = useState(false);
            const audioRef = useRef(null);

            if (!note) return null;

            const handleReadAloud = async () => {
                if (isReading) {
                    if (audioRef.current) audioRef.current.stop();
                    setIsReading(false);
                    return;
                }

                setIsReading(true);
                // Construct a narrative script
                let script = `Manuscript analysis. The Axiom. ${note.quote}. `;
                note.points.forEach((p, i) => {
                    script += `Point ${i+1}. ${p.one_word}. ${p.phrase}. Synthesis: ${p.inference}. `;
                });

                audioRef.current = await speakText(script);
                if (audioRef.current) {
                    audioRef.current.onended = () => setIsReading(false);
                } else {
                    setIsReading(false);
                }
            };

            const copyToGDocs = () => {
                const htmlContent = `
                    <div style="font-family: 'Times New Roman', serif; color: #000; max-width: 600px;">
                        <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 16px;">Manuscript Analysis</h1>
                        <blockquote style="font-size: 18px; font-style: italic; border-left: 4px solid #4f46e5; padding-left: 16px; margin-bottom: 24px; color: #333;">
                            "${note.quote}"
                        </blockquote>
                        <hr style="border: 0; border-top: 1px solid #ddd; margin: 24px 0;">
                        ${note.points.map(p => `
                            <div style="margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: bold; text-transform: uppercase; color: #444; margin-bottom: 4px;">${p.one_word}: ${p.phrase}</h3>
                                <p style="font-size: 14px; line-height: 1.6; margin-bottom: 8px;">${p.corrected_text}</p>
                                <p style="font-size: 12px; color: #666; font-style: italic;"><strong>Synthesis:</strong> ${p.inference}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const clipboardItem = new ClipboardItem({ 'text/html': blob });
                navigator.clipboard.write([clipboardItem]).then(() => {
                    alert('Copied to clipboard! Ready to paste into Google Docs.');
                });
            };

            // Stop audio when modal closes
            useEffect(() => {
                return () => {
                    if (audioRef.current) audioRef.current.stop();
                };
            }, []);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-zinc-900/20 backdrop-blur-sm animate-enter">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto flex flex-col">
                        <div className="sticky top-0 bg-white/95 backdrop-blur z-10 px-8 py-5 border-b border-zinc-100 flex justify-between items-center">
                            <h2 className="text-lg font-bold font-serif text-zinc-800">Archived Manuscript</h2>
                            <div className="flex gap-2">
                                <button onClick={handleReadAloud} className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${isReading ? 'bg-indigo-100 text-indigo-700' : 'bg-zinc-100 text-zinc-700 hover:bg-zinc-200'}`}>
                                    {isReading ? <StopCircle size={16} /> : <Volume2 size={16} />}
                                    <span className="hidden sm:inline">{isReading ? 'Stop Reading' : 'Listen'}</span>
                                </button>
                                <button onClick={copyToGDocs} className="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 text-sm font-medium transition-colors">
                                    <Copy size={16} /> <span className="hidden sm:inline">Copy for GDocs</span>
                                </button>
                                <button onClick={onClose} className="p-2 text-zinc-400 hover:text-zinc-600 rounded-lg hover:bg-zinc-100">
                                    <X size={20} />
                                </button>
                            </div>
                        </div>
                        <div className="p-8 md:p-12 space-y-8">
                            <div>
                                <h3 className="text-xs font-bold text-zinc-400 uppercase tracking-widest mb-4">The Axiom</h3>
                                <p className="text-2xl font-serif text-zinc-900 leading-relaxed">"{note.quote}"</p>
                            </div>
                            <div className="space-y-8">
                                <h3 className="text-xs font-bold text-zinc-400 uppercase tracking-widest border-b border-zinc-100 pb-2">The Dialectic</h3>
                                {note.points.map((point, i) => (
                                    <div key={i} className="pl-6 border-l-2 border-indigo-100">
                                        <div className="flex items-center gap-3 mb-2">
                                            <span className="text-lg font-serif font-medium text-indigo-900">{point.one_word}</span>
                                            <span className="text-zinc-400 text-sm">•</span>
                                            <span className="text-sm text-zinc-500 uppercase tracking-wide">{point.phrase}</span>
                                        </div>
                                        <p className="text-zinc-800 leading-relaxed mb-3">{point.corrected_text}</p>
                                        <div className="bg-zinc-50 p-4 rounded-lg border border-zinc-100">
                                            <p className="text-sm text-zinc-600 italic">
                                                <span className="font-semibold not-italic text-indigo-600 text-xs uppercase mr-2">Synthesis</span>
                                                {point.inference}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ onNewNote, user }) => {
            const [notes, setNotes] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [loading, setLoading] = useState(true);
            const [selectedNote, setSelectedNote] = useState(null);

            useEffect(() => {
                if (!user) return;
                const unsubscribe = db.collection('artifacts').doc(appId)
                    .collection('users').doc(user.uid).collection('notes')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        setNotes(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false);
                    }, (error) => {
                        console.error("Firestore Error:", error);
                        // Optional: alert("Could not fetch notes. Check permissions.");
                    });
                return () => unsubscribe();
            }, [user]);

            const filteredNotes = notes.filter(note => 
                (note.quote || "").toLowerCase().includes(searchTerm.toLowerCase()) ||
                (note.points || []).some(p => (p.tags || []).some(t => t.toLowerCase().includes(searchTerm.toLowerCase())))
            );

            return (
                <div className="min-h-screen p-6 md:p-12 max-w-6xl mx-auto animate-enter">
                    <header className="flex justify-between items-center mb-16">
                        <div className="flex items-center gap-4">
                            <div className="w-10 h-10 bg-zinc-900 rounded-xl flex items-center justify-center shadow-lg shadow-zinc-200">
                                <Brain size={20} className="text-white" />
                            </div>
                            <div>
                                <h1 className="text-2xl font-serif font-bold text-zinc-900">DeepNote</h1>
                                <p className="text-xs text-zinc-500 uppercase tracking-widest font-medium">Lumina Edition</p>
                            </div>
                        </div>
                        <button onClick={onNewNote} className="group flex items-center gap-2 px-6 py-3 bg-zinc-900 text-white rounded-full hover:bg-zinc-800 transition-all shadow-xl shadow-zinc-200 hover:shadow-2xl hover:-translate-y-0.5 font-medium text-sm">
                            <Plus size={16} /> <span>New Manuscript</span>
                        </button>
                    </header>

                    <CitationOfTheDay notes={notes} onClick={setSelectedNote} />

                    <div className="flex items-center gap-4 mb-8 bg-white p-2 rounded-2xl shadow-sm border border-zinc-100 max-w-lg">
                        <div className="p-2 bg-zinc-50 rounded-xl text-zinc-400">
                            <Search size={20} />
                        </div>
                        <input 
                            type="text" 
                            placeholder="Query the archives..." 
                            className="w-full bg-transparent text-zinc-700 placeholder-zinc-400 font-medium"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>

                    {loading ? (
                        <div className="flex justify-center py-20 text-zinc-400"><Loader2 className="animate-spin" /></div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredNotes.map(note => (
                                <div key={note.id} onClick={() => setSelectedNote(note)} className="group glass-panel rounded-2xl p-6 hover:shadow-xl hover:border-indigo-100 hover:-translate-y-1 transition-all cursor-pointer flex flex-col h-full bg-white">
                                    <div className="mb-6">
                                        <Quote size={16} className="text-indigo-200 mb-3" />
                                        <p className="text-zinc-800 font-serif text-lg leading-relaxed line-clamp-3 group-hover:text-indigo-900 transition-colors">
                                            "{note.quote}"
                                        </p>
                                    </div>
                                    <div className="mt-auto pt-4 border-t border-zinc-50">
                                        <div className="flex flex-wrap gap-2 mb-4">
                                            {(note.points && note.points[0]?.tags ? note.points[0].tags : []).slice(0, 3).map((tag, i) => (
                                                <span key={i} className={`text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-md border ${getColorForTag(tag)}`}>
                                                    #{tag}
                                                </span>
                                            ))}
                                        </div>
                                        <div className="flex justify-between items-center text-xs text-zinc-400 font-mono">
                                            <span>{new Date(note.createdAt?.toDate()).toLocaleDateString()}</span>
                                            <span className="flex items-center gap-1"><FileText size={12} /> {note.points ? note.points.length : 0}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {selectedNote && <ReaderModal note={selectedNote} onClose={() => setSelectedNote(null)} />}
                </div>
            );
        };

        const NoteFlow = ({ onComplete, onCancel }) => {
            const [step, setStep] = useState('AXIOM'); 
            const [quote, setQuote] = useState("");
            const [points, setPoints] = useState([]); 
            const [currentInput, setCurrentInput] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [currentAnalysisResult, setCurrentAnalysisResult] = useState(null);

            const handleQuoteSubmit = () => { if (quote.trim()) setStep('DIALECTIC'); };

            const handleAnalysisSubmit = async () => {
                if (!currentInput.trim()) return;
                setIsAnalyzing(true);
                const result = await generateAIAnalysis(quote, currentInput);
                setCurrentAnalysisResult(result);
                setIsAnalyzing(false);
            };

            const confirmAnalysisPoint = () => {
                if (!currentAnalysisResult) return;
                setPoints([...points, currentAnalysisResult]);
                setCurrentInput("");
                setCurrentAnalysisResult(null);
            };

            const finishSession = () => {
                if (currentAnalysisResult) setPoints([...points, currentAnalysisResult]);
                setStep('DEFENSE');
            };

            // Keyboard Handlers
            const handleQuoteKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleQuoteSubmit();
                }
            };

            const handleAnalysisKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleAnalysisSubmit();
                }
            };

            if (step === 'AXIOM') {
                return (
                    <div className="min-h-screen flex flex-col justify-center max-w-3xl mx-auto p-8 animate-enter relative">
                        <button onClick={onCancel} className="absolute top-8 left-8 p-3 hover:bg-zinc-100 rounded-full text-zinc-400 transition-colors">
                            <X size={24} />
                        </button>
                        <div className="space-y-8">
                            <div>
                                <span className="text-indigo-600 font-bold tracking-widest text-xs uppercase mb-2 block">Phase I</span>
                                <h2 className="text-4xl md:text-5xl font-serif text-zinc-900">The Axiom</h2>
                                <p className="text-zinc-500 mt-2">Input the primary source material.</p>
                            </div>
                            <textarea 
                                autoFocus
                                value={quote}
                                onChange={(e) => setQuote(e.target.value)}
                                onKeyDown={handleQuoteKeyDown}
                                placeholder="Type the quote here..."
                                className="w-full bg-white text-2xl md:text-3xl text-zinc-800 placeholder-zinc-300 resize-none border-l-4 border-indigo-500 pl-6 py-4 h-64 focus:bg-zinc-50 transition-colors"
                            />
                            <div className="flex justify-end">
                                <button 
                                    onClick={handleQuoteSubmit}
                                    disabled={!quote.trim()}
                                    className="flex items-center gap-3 px-10 py-4 bg-zinc-900 text-white rounded-full font-bold hover:bg-zinc-800 disabled:opacity-50 transition-all shadow-xl hover:shadow-2xl hover:-translate-y-1"
                                >
                                    Establish Axiom <ArrowRight size={18} />
                                </button>
                            </div>
                            <p className="text-center text-xs text-zinc-300 font-mono">Press [Enter] to continue</p>
                        </div>
                    </div>
                );
            }

            if (step === 'DIALECTIC') {
                return (
                    <div className="min-h-screen flex flex-col max-w-5xl mx-auto p-6 md:p-12 animate-enter">
                        <div className="py-8 border-b border-zinc-100 flex justify-between items-start mb-12">
                            <div className="max-w-3xl">
                                <span className="text-indigo-600 font-bold tracking-widest text-xs uppercase mb-2 block">The Axiom</span>
                                <p className="text-lg md:text-xl font-serif italic text-zinc-700">"{quote}"</p>
                            </div>
                            <div className="text-right hidden md:block">
                                <span className="text-xs text-zinc-400 block uppercase tracking-wider mb-1">Deductions</span>
                                <span className="text-2xl font-mono font-bold text-indigo-600">{points.length}</span>
                            </div>
                        </div>

                        <div className="flex-1 flex flex-col justify-center space-y-10">
                            {!currentAnalysisResult ? (
                                <div className="space-y-8 animate-enter max-w-3xl mx-auto w-full">
                                    <div>
                                        <h2 className="text-3xl font-serif text-zinc-900 mb-2">The Dialectic</h2>
                                        <p className="text-zinc-500">Postulate your thesis for analysis.</p>
                                    </div>
                                    <div className="relative group">
                                        <textarea 
                                            autoFocus
                                            value={currentInput}
                                            onChange={(e) => setCurrentInput(e.target.value)}
                                            onKeyDown={handleAnalysisKeyDown}
                                            placeholder="Enter raw datum..."
                                            className="w-full bg-white p-8 rounded-3xl text-xl text-zinc-800 placeholder-zinc-300 resize-none h-48 border-2 border-zinc-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50 transition-all shadow-sm"
                                        />
                                        {isAnalyzing && (
                                            <div className="absolute inset-0 bg-white/90 backdrop-blur-sm rounded-3xl flex flex-col items-center justify-center z-10 border-2 border-indigo-50">
                                                <Loader2 className="text-indigo-600 animate-spin mb-4" size={40} />
                                                <p className="text-sm text-indigo-900 font-bold tracking-widest animate-pulse">TRANSMUTING...</p>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <button onClick={points.length > 0 ? finishSession : onCancel} className="text-zinc-400 hover:text-zinc-900 transition-colors text-sm font-medium px-4">
                                            {points.length > 0 ? "Conclude Dialectic" : "Abort Manuscript"}
                                        </button>
                                        <button 
                                            onClick={handleAnalysisSubmit}
                                            disabled={!currentInput.trim() || isAnalyzing}
                                            className="px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-bold text-sm transition-all shadow-lg hover:shadow-indigo-200 flex items-center gap-2"
                                        >
                                            Synthesize <Brain size={18} />
                                        </button>
                                    </div>
                                    <p className="text-center text-xs text-zinc-300 font-mono">Press [Enter] to synthesize</p>
                                </div>
                            ) : (
                                <div className="space-y-8 animate-enter max-w-4xl mx-auto w-full">
                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                                        <div className="md:col-span-8 bg-white p-8 rounded-3xl border border-zinc-100 shadow-sm">
                                            <div className="flex items-center gap-2 mb-4 text-zinc-400 text-xs font-bold uppercase tracking-wider">
                                                <span className="text-emerald-600">Refined Thesis</span>
                                            </div>
                                            <p className="text-xl text-zinc-800 leading-relaxed font-serif">
                                                {currentAnalysisResult.corrected_text}
                                            </p>
                                        </div>

                                        <div className="md:col-span-4 bg-indigo-600 text-white p-8 rounded-3xl shadow-xl shadow-indigo-200 flex flex-col justify-center text-center">
                                            <div className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-2">Essence</div>
                                            <p className="text-3xl font-serif italic mb-2">{currentAnalysisResult.one_word}</p>
                                            <p className="text-sm text-indigo-100 opacity-80">{currentAnalysisResult.phrase}</p>
                                        </div>

                                        <div className="md:col-span-12 glass p-8 rounded-3xl">
                                            <div className="text-zinc-400 text-xs font-bold uppercase tracking-wider mb-3">Synthesis</div>
                                            <p className="text-lg text-zinc-700 leading-relaxed">
                                                "{currentAnalysisResult.inference}"
                                            </p>
                                            <div className="mt-6 flex flex-wrap gap-2">
                                                {currentAnalysisResult.tags.map((tag, i) => (
                                                    <span key={i} className={`px-3 py-1.5 rounded-md text-xs font-bold uppercase tracking-wider border ${getColorForTag(tag)}`}>
                                                        #{tag}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-4 pt-4 border-t border-zinc-100">
                                        <button onClick={() => { setCurrentInput(""); setCurrentAnalysisResult(null); }} className="px-6 py-3 rounded-xl text-zinc-500 hover:bg-zinc-100 font-medium transition-colors">
                                            Discard
                                        </button>
                                        <button onClick={confirmAnalysisPoint} className="px-10 py-3 bg-zinc-900 text-white rounded-xl font-bold hover:bg-zinc-800 transition-all shadow-lg flex items-center gap-2">
                                            Ratify & Continue <ArrowRight size={18} />
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (step === 'DEFENSE') {
                return (
                    <ReviewScreen 
                        quote={quote} 
                        points={points} 
                        onSave={(data) => onComplete(data)}
                        onBack={() => setStep('DIALECTIC')} 
                        onDiscard={onCancel}
                    />
                );
            }
        };

        const ReviewScreen = ({ quote, points, onSave, onBack, onDiscard }) => {
            const [isSaving, setIsSaving] = useState(false);
            const [isReading, setIsReading] = useState(false);
            const audioRef = useRef(null);

            const handleSave = async () => {
                setIsSaving(true);
                await onSave({ quote, points, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            };

            const handleReadAloud = async () => {
                if (isReading) {
                    if (audioRef.current) audioRef.current.stop();
                    setIsReading(false);
                    return;
                }
                setIsReading(true);
                let script = `The Defense. The Axiom: ${quote}. `;
                points.forEach((p, i) => {
                    script += `Deduction ${i+1}. ${p.corrected_text}. Essence: ${p.one_word}. Inference: ${p.inference}. `;
                });
                audioRef.current = await speakText(script);
                if (audioRef.current) audioRef.current.onended = () => setIsReading(false);
                else setIsReading(false);
            };

            useEffect(() => {
                return () => { if (audioRef.current) audioRef.current.stop(); }
            }, []);

            return (
                <div className="min-h-screen max-w-4xl mx-auto p-8 animate-enter pb-40">
                    <div className="mb-12 flex items-center justify-between">
                        <div>
                            <span className="text-indigo-600 font-bold tracking-widest text-xs uppercase mb-2 block">Phase III</span>
                            <h2 className="text-3xl font-serif text-zinc-900">The Defense</h2>
                        </div>
                        <div className="flex gap-2">
                             <button onClick={handleReadAloud} className={`p-3 rounded-xl transition-colors ${isReading ? 'bg-indigo-100 text-indigo-700' : 'bg-white hover:bg-zinc-50 text-zinc-600 border border-zinc-100'}`} title="Read Aloud">
                                {isReading ? <StopCircle size={20} /> : <Volume2 size={20} />}
                            </button>
                            <button onClick={onDiscard} className="p-3 hover:bg-red-50 text-red-400 rounded-xl transition-colors" title="Burn Manuscript"><Trash2 size={20} /></button>
                        </div>
                    </div>

                    <div className="space-y-12">
                        <div className="bg-white p-10 rounded-3xl border border-zinc-100 shadow-sm relative overflow-hidden">
                             <div className="absolute top-0 left-0 w-2 h-full bg-indigo-600"></div>
                            <Quote size={32} className="text-indigo-100 mb-6" />
                            <p className="text-2xl md:text-3xl font-serif text-zinc-900 leading-relaxed">"{quote}"</p>
                        </div>

                        <div className="relative border-l-2 border-zinc-100 ml-4 pl-10 space-y-12 py-4">
                            {points.map((point, idx) => (
                                <div key={idx} className="relative group">
                                    <div className="absolute -left-[49px] top-0 h-4 w-4 rounded-full bg-white border-4 border-indigo-600 z-10 box-content shadow-sm"></div>
                                    <div className="glass-panel rounded-2xl p-8 transition-all hover:bg-white hover:shadow-md">
                                        <div className="flex flex-col md:flex-row md:items-baseline md:justify-between gap-4 mb-4">
                                            <div className="flex items-baseline gap-3">
                                                <h3 className="text-2xl font-serif font-bold text-zinc-900">{point.one_word}</h3>
                                                <p className="text-zinc-400 font-mono text-xs uppercase tracking-widest">{point.phrase}</p>
                                            </div>
                                            <div className="flex flex-wrap gap-2">
                                                {(point.tags || []).slice(0,3).map((t, i) => (
                                                    <span key={i} className={`text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded border ${getColorForTag(t)}`}>#{t}</span>
                                                ))}
                                            </div>
                                        </div>
                                        <p className="text-zinc-700 leading-relaxed mb-4 text-lg">{point.corrected_text}</p>
                                        <div className="text-sm text-zinc-500 bg-zinc-50 p-4 rounded-xl border border-zinc-100">
                                            <span className="font-bold text-indigo-600 uppercase text-xs mr-2">Inference</span>
                                            {point.inference}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-zinc-100 py-6 px-6 z-20">
                        <div className="max-w-4xl mx-auto flex gap-4">
                            <button onClick={onBack} className="flex-1 py-4 bg-zinc-100 text-zinc-600 rounded-xl font-bold hover:bg-zinc-200 transition-colors">
                                Revise Thesis
                            </button>
                            <button onClick={handleSave} disabled={isSaving} className="flex-[2] py-4 bg-zinc-900 text-white rounded-xl font-bold hover:bg-zinc-800 transition-all shadow-xl hover:shadow-2xl flex items-center justify-center gap-3">
                                {isSaving ? <Loader2 className="animate-spin" /> : <Save size={20} />}
                                Archive to Vault
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('DASHBOARD');

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        const { user } = await auth.signInAnonymously();
                        setUser(user);
                    } catch (error) { console.error("Auth Error", error); }
                };
                const unsubscribe = auth.onAuthStateChanged((u) => u ? setUser(u) : initAuth());
                return () => unsubscribe();
            }, []);

            const saveNote = async (noteData) => {
                if (!user) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('notes').add(noteData);
                    setView('DASHBOARD');
                } catch (error) { console.error("Save Error", error); }
            };

            if (!user) return <div className="min-h-screen bg-zinc-50 flex items-center justify-center"><Loader2 className="animate-spin text-zinc-400" /></div>;

            return (
                <div className="min-h-screen bg-zinc-50 text-zinc-900 selection:bg-indigo-100 selection:text-indigo-900">
                    {view === 'DASHBOARD' ? <Dashboard user={user} onNewNote={() => setView('EDITOR')} /> : <NoteFlow onComplete={saveNote} onCancel={() => setView('DASHBOARD')} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
